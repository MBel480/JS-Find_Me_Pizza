<!DOCTYPE html>

<html>
	<head>

		<title>Find the Pizza</title>
		<meta charset="UTF-8">
		<link rel="stylesheet" type="text/css" href="locator.css">
		<script type="text/javascript" src="keys.js"></script>
		
	</head>

	<body background="koomis_pizza.jpg">

		<div id="container">

			<div id="titlebar"></div>

			<div id="map"></div>

			<div id="datatable"></div>

			<div id="latLng">
				<form action="">
					<fieldset>

						<label>Map Latitude (deg):</label>
						<input readonly type="text" id="lat"/>
						<label>Map Longitude (deg):</label>
						<input readonly type="text" id="lng"/>
						<label>Marker Latitude (deg):</label>
						<input readonly type="text" id="marklat"/>
						<label>Marker Longitude (deg):</label>
						<input readonly type="text" id="marklng"/>

					</fieldset>
				</form>
			</div>

			<div id="radius">
				<form action="">
					<fieldset>
						<label>Search Radius (miles)</label>
						<input type="number" id="rad_input"
						min="1" max="6" maxlength="3"
						onpaste="return false" onkeydown="return validNumericInput(event)">
					</fieldset>
				</form>
			</div>
		</div>

			<script>

				var mainMap;
				var	earthR = 6371;  //Mean radius of Earth (km)
				var	mapMarkers = [];
				var	searchRadii = [];
				var	coordDecimals = 7;
				var distDecimals = 3;
				var	ajaxResponse;
				var	secureKeys = apiKeys();
				var	tableEntry;

				function initMap() {

					/*
					============================
					Map centered on Washington, D.C.
					with main map controls active
					==============================
					*/

					var	mapDiv = document.getElementById('map');

					var mapOptions = {

					center: new google.maps.LatLng(38.889931, -77.009003),

					zoom: 10,

					zoomControl: true,

					mapTypeControl: true,

					scaleControl: true,

					streetViewControl: true,

					mapTypeId: google.maps.MapTypeId.HYBRID
		
					};

					var geoCodeInfo = new google.maps.Geocoder;

					mainMap = new google.maps.Map(mapDiv, mapOptions);

					document.getElementById("lat").value = mapOptions.center.lat();
					document.getElementById("lng").value = mapOptions.center.lng();

					/*
					============================
					Map center change displays
					latitude and longitude
					==============================
					*/

					google.maps.event.addListener(mainMap, "center_changed", function() {

						var latOutput = document.getElementById("lat");
						var lngOutput = document.getElementById("lng");

						latOutput.value = mainMap.getCenter().lat().toFixed(coordDecimals);
						lngOutput.value = mainMap.getCenter().lng().toFixed(coordDecimals);


					});

					/*
					============================
					Initial map marker location
					set to map center
					==============================
					*/

					locationMarker = new google.maps.Marker({
								map: mainMap,
								draggable: true,
								position: mainMap.getCenter(),
								icon: "http://maps.google.com/mapfiles/kml/pal3/icon20.png"
							});

					mapMarkers.push(locationMarker);


					/*
					============================
					Marker position change displays
					latitude and longitude
					==============================
					*/
					
					document.getElementById("marklat").value = mapOptions.center.lat();
					document.getElementById("marklng").value = mapOptions.center.lng();	

					google.maps.event.addListener(locationMarker, "drag", function() {

						document.getElementById("marklat").value = 
						locationMarker.getPosition().lat().toFixed(coordDecimals);

						document.getElementById("marklng").value = 
						locationMarker.getPosition().lng().toFixed(coordDecimals);

					});

					/*============================
					Ensure map marker maintains its
					position at center of map, when
					user finishes dragging the map
					to a new location
					==============================*/

					google.maps.event.addListener(mainMap, "dragend", function() {

						removeFromMap(mapMarkers);
						removeFromMap(searchRadii);

						locationMarker.position = mainMap.getCenter();
						locationMarker.setMap(mainMap);	

						mapMarkers.push(locationMarker);

						document.getElementById("marklat").value = locationMarker.getPosition()
																	.lat().toFixed(coordDecimals);

						document.getElementById("marklng").value = locationMarker.getPosition()
																	.lng().toFixed(coordDecimals);
						//Refactor locationMarker.getPosition into a function
					});

					/*
					============================
					Marker terminal position displays
					search radius
					==============================
					*/

					google.maps.event.addListener(locationMarker, "click", function() {

						if (document.getElementById('restable')) {

							document.getElementById('datatable').innerHTML = '';

						}

						if (searchRadii.length !== 0) {

							removeFromMap(searchRadii);
							searchRadii = [];

						}

						var searchRadius = new google.maps.Circle({

							map: mainMap,
							radius: milesToMeters(document.getElementById("rad_input").value),
							fillColor: '#AA0000'

						});

						searchRadii.push(searchRadius);
						searchRadius.bindTo('center', locationMarker, 'position');

						var searchLat = getElement("id", "marklat");
						var	searchLng = getElement("id", "marklng");
						var	factualParams;
						var	factualUrl;
						var	factualRadius = searchRadius.radius;
							

						var geoLatLng = {lat: parseFloat(searchLat), lng: parseFloat(searchLng)},
							countryCode;

						geoCodeInfo.geocode({'location': geoLatLng}, function req(results, status) {

							if (status === google.maps.GeocoderStatus.OK) {

								var resultsLen = results.length;
								var res;

								for (res = 0; res < resultsLen; res++) {

									if (results[res].types.indexOf("country") !== -1) {

										countryCode = results[res].address_components[0]
										.short_name.toLowerCase();
										break;
									}

								}

							} else {

								if (status === google.maps.GeocoderStatus.OVER_QUERY_LIMIT) {

									setTimeout(function() {

										req(results, status);

									}, 200);

								} else {

									return;
								}

							}

							if (countryCode) {

								factualParams = [countryCode, geoLatLng.lat, geoLatLng.lng, factualRadius];
								factualUrl = apiEncodeUrl('factual', factualParams);
								ajaxRequest(factualUrl, buildResultTable);
							}

						});

						mainMap.setCenter(geoLatLng);
						mainMap.setZoom(13);

					});

					/*
					============================
					Center map using geolocation 
					(if supported by browser)
					==============================
					*/

					getCurrentLocation();

				};

				function getCurrentLocation() {

					if (navigator.geolocation) {

						navigator.geolocation.getCurrentPosition(showPosition);

					}else {

					
						alert("Geolocation is not supported by your browser.");

					}

				};

				function showPosition(position) {

					var presentLocation = new google.maps.LatLng(position.coords.latitude,
						position.coords.longitude);

					mainMap.setCenter(presentLocation);
				};

				function removeFromMap(itemArray) {
					
					var i = 0;

					for (i = 0; i < itemArray.length; i++) {

						itemArray[i].setMap(null);

					}
				};

				function milesToMeters(radius) {

					return radius * 5280 * (1200 / 3937);

				};

				function metersToMiles(radius) {

					return radius * (3937 / (1200 * 5280));

				}

				function greatCircleDistance(lat1, lng1, lat2, lng2) {

					/*
					========================================
					Compute great circle distance from center of 
					search circle to locations discovered in 
					database that fall within search radius bounds
					======================================== 
					*/

					var coordsArray = Array.prototype.slice.call(arguments),
						convertedCoords,
						deltaLng,
						sinProduct,
						cosProduct, dist;

					convertedCoords = coordsArray.map(function(num) {
						return degreesToRadians(num);
					});

					deltaLng = Math.cos(convertedCoords[3] - convertedCoords[1]);

					sinProduct = Math.sin(convertedCoords[0]) * 
								Math.sin(convertedCoords[2]);

					cosProduct = Math.cos(convertedCoords[0]) *
								Math.cos(convertedCoords[2]);

					dist = Math.acos(sinProduct + cosProduct * deltaLng) * earthR;

					return (dist * 1000);

				};


				function degreesToRadians(coordinate) {

					return coordinate * Math.PI / 180;

				};

				function radiansToDegrees(coordinate) {

					return coordinate * 180 / Math.PI;

				};

				function ajaxRequest(url, callback) {

					var xhttpR;

					if (typeof XMLHttpRequest !== 'undefined') {

						xhttpR = new XMLHttpRequest();

					}else {

						var actxVersions = ["MSXML2.XmlHttp.5.0",
											"MSXML2.XmlHttp.4.0",
											"MSXML2.XmlHttp.3.0",
											"MSXML2.XmlHttp.2.0",
											"Microsoft.XmlHttp"
											];

						var i,
							actxArrLen = actxVersions.length;

						for (i = 0; i < actxArrLen; i++) {

							try {

								xhttpR = new ActiveXObject(actxVersions[i]);
								break;

							} catch(error) {

								alert('ActiveX not enabled in this browser; enable ActiveX');

							}
						}
					}

					xhttpR.onreadystatechange = checkReadiness;

					function checkReadiness() {

						/*
						========================================

						 XMLHttpRequest object readyState properties:

						 0: request not initialized
						 1: server connection established
						 2: request received
						 3: processing request
						 4: request finished and response ready

						 200: status "OK"
						 404: status "Page not found"
						========================================
						*/

						if (xhttpR.readyState < 4) {

							return;

						}

						if (xhttpR.status !== 200) {

							return;

						}

						if (xhttpR.readyState == 4) {

							return callback(xhttpR.responseText);

						}
					}

					//Send query url to API server

					xhttpR.open('GET', url, true);
					xhttpR.send('');

				};

				function processAjaxResponse(response) {

					response = JSON.parse(response);

					return response.response.data;

				};

				function buildResultTable(response) {

					var infoArray = processAjaxResponse(response),

						table = document.createElement('table'),
						tRow,
						tableProperties; //, tHead, tRow;

					document.getElementById('datatable').appendChild(table);

					var tableProperties = {"id" : "restable", "cellspacing" : 0,
										   "border" : "1"};

					setElementAttributes(table, tableProperties);

					var headerValues = {

										"Name"             : "name", 
										"Address"          : "address", 
										"Suite"            : "address_extended", 
										"City"             : "locality",
										"Phone"            : "tel", 
										"Website"  	       : "website", 
										"Distance (miles)" : "$distance"

									   };

					tableCells(table, [headerValues, {}], 'head');

					var tBody = document.createElement('tbody');

					tableCells(tBody, [headerValues, infoArray], 'body');

					document.getElementById('restable').appendChild(tBody);

				};

				function setElementAttributes(el, attribs) {

					/*
					========================================
					attribs is an object containing attributes 
					to apply to the DOM element, el, 
					via the chosen method
					========================================
					*/

					for (key in attribs) {

						el.setAttribute(key, attribs[key]);

					}

				};

				function getElement(type, name) {

					switch (type) {

						case "id":
							return document.getElementById(name).value;
							break;

						case "class":
							return document.getElementsByClassName(name).value;
							break;

						case "tag":
							return document.getElementsByTagName(name).value;
							break;

					}

				};

				function tableCells(tableSeg, cellValues, type) {

					var headers = cellValues[0];
					var headKeys = Object.keys(cellValues[0]);
					var headLen = headKeys.length;

					switch (type) {
						//Modify CSS to ensure header row in fixed position while scrolling
						case 'head':

							var i; 
							var j;
							
							var tHead = tableSeg.createTHead();
							var row = tHead.insertRow(-1);
							var headCell;

							for (i = 0; i < headLen; i++) {

								headCell = document.createElement("TH");

								headCell.innerHTML = headKeys[i];

								row.appendChild(headCell);

							}

						break;

						case 'body':

							var info = cellValues[1];
							var uniquePhone = [];

								/*
								========================================
								Tabulated results sorted by distance
								(ascending order) and without repeated
								entries.  Results will all be within
								the specified search radius.
								========================================
								*/

								info = info.sort(function(first, second) {

									return first.$distance - second.$distance;

								})

								info = info.filter(function(obj) {

									if (obj.hasOwnProperty("locality") && 
										uniquePhone.indexOf(obj.tel) === -1 &&
										Number(getElement("id", "rad_input")) 
										>= metersToMiles(obj.$distance)) {

										uniquePhone.push(obj.tel);

										return obj;

									}

								});

							var	infoLen = info.length;
							var keyName;
							var	row;
								

							for (i = 0; i < infoLen; i++) {

								row = tableSeg.insertRow(i);

								for (j = 0; j < headLen; j++) {

									tableEntry = row.insertCell(j);

									keyName = headers[headKeys[j]];

									if (info[i].hasOwnProperty(keyName)) {

										switch (keyName) {

											case 'website':

												tableEntry.innerHTML = '<a target="_blank" href=' + "\"" +
												info[i][keyName] + "\"" + '>' + info[i][keyName] + 
												'</a>';

											break;

											case '$distance':

												var lat1 = Number(getElement("id", "marklat"));
												var lng1 = Number(getElement("id", "marklng"));
												var lat2 = info[i].latitude;
												var lng2 = info[i].longitude;

												mapMarkers.push(new google.maps.Marker({
													map: mainMap,
													icon: "pizza.png",
													position: new google.maps.LatLng(lat2, lng2),
													title: info[i].name
												}));

												var gcDistance = greatCircleDistance(lat1, lng1, lat2, lng2);

												tableEntry.innerHTML = 
													metersToMiles(gcDistance).toFixed(distDecimals);

											break;

											default:

												tableEntry.innerHTML = info[i][keyName];
										}

									}else {

										tableEntry.innerHTML = '';
									}
								}


							}

							break;
					}

				};

				function apiEncodeUrl(type, params) {

					var first,        country,   
						filter,       category,  
						geo,          radius,    
						resultLimit,  googleKey, 
						factualKey,   urlParts;

					switch (type) {

						case 'google':

							first = 'https://maps.googleapis.com',
							filter = '/maps/api/geocode/json?',
							geo = 'latlng=' + params[1] + ',' + params[2],
							googleKey = '&key=' + secureKeys[0];

							urlParts = [first, filter,
										geo,   googleKey
									   ];

						break;

						case 'factual':

							first = 'http://api.v3.factual.com/t/places-',
							country = params[0],
							filter = '?filters=',
							category = '{"category_ids":{"$includes":363}}',

							geo = '&geo={"$circle":{"$center":[' + params[1] + ',' +
								   params[2] + '],',

							radius = '"$meters"' +  ':' +  params[3] + '}}',
							resultLimit = '&limit=50',
							factualKey = '&KEY=' + secureKeys[1];

							urlParts = [first,       country, 
										filter,      category, 
										geo,         radius,
										resultLimit, factualKey
									   ];

						break;
					}

					return encodeURI(urlParts.join(''));

				};

				function validNumericInput(event) {

				/*
				validNumericInput restricts search
				radius input box into accepting
				only numbers and certain
				keyboard key actions
				*/

				//Cross-browser key code extraction method selection

				var key = (event.which) ? event.which : event.keyCode;

					//Numbers 0-9
				if (key >= 48 && key <= 57   ||
					//Numbers 0-9 (keypad)
					key >= 96 && key <= 105  ||
					//Delete and Back Space keys
					key === 46 || key === 8 ||
					//Left and Right arrow keys
					key === 37  || key === 39)  {

					return true;

					//Period key check (keyboard 110; keypad: 190)
				}else if (key === 110 || key === 190) {

					//Ensure only one period allowed in input box
					if ((document.getElementById('rad_input').value)
						.indexOf('.') === -1) {
						
						return true;

					}

				}

				return false;

			};

			</script>

			<script src='locator.js?onload=initialize'></script>

			<script async defer
				src="https://maps.googleapis.com/maps/api/js?callback=initMap"
			></script>

	</body>

</html>